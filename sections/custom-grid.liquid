{% schema %}
{
  "name": "Product Grid with Popup",
  "settings": [],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select product"
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Product Grid Popup",
      "blocks": [
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}

<div class="gp-grid">
  {% for block in section.blocks %}
    {% assign p = all_products[block.settings.product] %}
    {% if p %}
      <div class="gp-tile" data-handle="{{ p.handle }}">
        <div class="gp-tile__card">
          {% if p.featured_image %}
            <img class="gp-tile__img" src="{{ p.featured_image | image_url: width: 600 }}" alt="{{ p.title | escape }}">
          {% endif %}
          <div class="gp-tile__meta">
            <div class="gp-tile__title">{{ p.title }}</div>
            <div class="gp-tile__price">{{ p.price | money }}</div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}
</div>

<!-- Popup -->
<div id="gp-popup" class="gp-popup">
  <div class="gp-popup__content">
    <span id="gp-popup-close" class="gp-popup__close">&times;</span>
    <div class="gp-popup__body">
      <img id="gp-popup-img" class="gp-popup__img" alt="">
      <h2 id="gp-popup-title"></h2>
      <p id="gp-popup-price"></p>
      <p id="gp-popup-desc"></p>
      <form id="gp-popup-form">
        <div id="gp-popup-variants"></div>
        <button type="submit" class="gp-btn">Add to Cart</button>
      </form>
    </div>
  </div>
</div>

<style>
/* GRID */
.gp-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
}
.gp-tile {
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.gp-tile:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.gp-tile__img {
  width: 100%;
  height: auto;
  border-radius: 8px;
}
.gp-tile__meta {
  padding: 8px 0;
  text-align: center;
  font-family: Arial, sans-serif;
}

/* POPUP */
.gp-popup {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}
.gp-popup__content {
  background: #fff;
  padding: 20px;
  max-width: 500px;
  width: 90%;
  border-radius: 10px;
  position: relative;
  animation: fadeIn 0.3s ease;
}
.gp-popup__close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 24px;
  cursor: pointer;
}
.gp-popup__img {
  width: 100%;
  height: auto;
  margin-bottom: 15px;
  border-radius: 6px;
}
.gp-btn {
  display: inline-block;
  padding: 10px 20px;
  margin-top: 15px;
  background: #111;
  color: #fff;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  transition: background 0.2s;
}
.gp-btn:hover { background: #333; }

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const popup = document.getElementById("gp-popup");
  const popupClose = document.getElementById("gp-popup-close");
  const popupImg = document.getElementById("gp-popup-img");
  const popupTitle = document.getElementById("gp-popup-title");
  const popupPrice = document.getElementById("gp-popup-price");
  const popupDesc = document.getElementById("gp-popup-desc");
  const popupVariants = document.getElementById("gp-popup-variants");
  const popupForm = document.getElementById("gp-popup-form");

  // Open popup
  document.querySelectorAll(".gp-tile").forEach(tile => {
    tile.addEventListener("click", async () => {
      const handle = tile.dataset.handle;
      if (!handle) return;

      const res = await fetch(`/products/${handle}.js`);
      const product = await res.json();

      popupTitle.textContent = product.title;
      popupPrice.textContent = (product.price / 100).toFixed(2) + " " + Shopify.currency.active;
      popupDesc.textContent = product.description.replace(/<[^>]*>?/gm, '');
      popupImg.src = product.featured_image;

      // Variants
      popupVariants.innerHTML = "";
      if (product.variants.length > 1) {
        product.options.forEach((opt, idx) => {
          const sel = document.createElement("select");
          sel.name = "option" + (idx + 1);
          product.options[idx].values.forEach(val => {
            const o = document.createElement("option");
            o.value = val;
            o.textContent = val;
            sel.appendChild(o);
          });
          popupVariants.appendChild(sel);
        });
      }

      popup.dataset.variants = JSON.stringify(product.variants);

      popup.style.display = "flex";
    });
  });

  // Close popup
  popupClose.addEventListener("click", () => popup.style.display = "none");
  window.addEventListener("click", e => { if (e.target === popup) popup.style.display = "none"; });

  // Add to cart
  popupForm.addEventListener("submit", async e => {
    e.preventDefault();

    const variants = JSON.parse(popup.dataset.variants);
    let selectedVariant = variants[0];

    // match variant from selects
    const selects = popupVariants.querySelectorAll("select");
    if (selects.length > 0) {
      variants.forEach(v => {
        if (selects.length === v.options.length &&
            v.options.every((opt, idx) => opt === selects[idx].value)) {
          selectedVariant = v;
        }
      });
    }

    // Add selected product
    await fetch("/cart/add.js", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: selectedVariant.id, quantity: 1 })
    });

    // Special condition: if Color = Black & Size = Medium â†’ add Soft Winter Jacket
    if (selectedVariant.options.includes("Black") && selectedVariant.options.includes("Medium")) {
      const jacket = await fetch("/products/soft-winter-jacket.js").then(r => r.json());
      if (jacket && jacket.variants[0]) {
        await fetch("/cart/add.js", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: jacket.variants[0].id, quantity: 1 })
        });
      }
    }

    alert("Added to cart!");
    popup.style.display = "none";
  });
});
</script>
